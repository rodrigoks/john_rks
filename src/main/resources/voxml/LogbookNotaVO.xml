<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="logbooknota">

    <insert id="insert" parameterType="LogbookNotaVO" useGeneratedKeys="true" keyProperty="id" >

        INSERT INTO logbook08_logbook_nota (
            flogbook07_id,
            flogbook08_emissor,
            flogbook08_cnpj_emissor,
            flogbook08_numero,
            flogbook08_serie,
            flogbook08_peso,
            flogbook08_valor,
            flogbook08_tipo_documento
        ) VALUES
        <foreach collection="collection" item="item" index="index" open="(" separator="),(" close=")" >
            #{item.logbook.id},
            #{item.emissor},
            #{item.cnpjEmissor},
            #{item.numero},
            #{item.serie},
            #{item.peso},
            #{item.valor},
            #{item.tipoDocumento}
        </foreach>

    </insert>
    
    <select id="selectByErros" resultMap="result" parameterType="FiltroLogbookVO" >
        SELECT
		  logbook08_logbook_nota.*
		FROM
		  logbook07_logbook
		LEFT JOIN
		  logbook08_logbook_nota
		ON
		  logbook07_logbook.flogbook07_id = logbook08_logbook_nota.flogbook07_id
		LEFT JOIN
		  logbook20_erros_pre_calculo
		ON
		  logbook08_logbook_nota.flogbook08_id = logbook20_erros_pre_calculo.flogbook08_id
		WHERE
		  flogbook07_status = 'E'
		AND (
		  	flogbook07_valor_pre_calculo = 0
		  OR
		  	flogbook07_valor_pre_calculo is null
        ) AND
          flogbook08_cnpj_emissor || flogbook08_numero || flogbook08_serie
        IN
        <foreach collection="collection" item="item" index="index" open="(" separator="," close=")" >
            #{item.cnpjEmissor} || #{item.notaFiscal} || #{item.serie}
        </foreach>
    </select>

    <resultMap id="result" type="LogbookNotaVO">
        <result property="id" column="flogbook08_id" />
        <result property="emissor" column="flogbook08_emissor" />
        <result property="cnpjEmissor" column="flogbook08_cnpj_emissor" />
        <result property="numero" column="flogbook08_numero" />
        <result property="serie" column="flogbook08_serie" />
        <result property="peso" column="flogbook08_peso" />
        <result property="valor" column="flogbook08_valor" />
        <result property="tipoDocumento" column="flogbook08_tipo_documento" />
        <collection property="colPrecalculos" ofType="ErroPrecalculoVO">
            <result property="id" column="flogbook20_id" />
	        <result property="notaFiscal" column="flogbook20_nota_fiscal" />
	        <result property="serie" column="flogbook20_serie" />
	        <result property="cnpjEmissor" column="flogbook20_cnpj_emissor" />
	        <result property="erro" column="flogbook20_erro" />
	        <result property="responsavel" column="flogbook20_responsavel" />
	        <result property="dataCadastro" column="flogbook20_data_cadastro" />
        </collection>
    </resultMap>

</mapper>