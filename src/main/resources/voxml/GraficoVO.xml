<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="grafico">

    <select id="selectTotal" resultMap="result" parameterType="GraficoVO" >
        SELECT 
        DISTINCT ON (flogbook07_week)
        COUNT(flogbook07_cte) as count,
        SUM(flogbook07_valor_emissao_cte) as valor,
        flogbook07_week as week
        FROM 
        	logbook07_logbook
        <if test="user.group.group == 'WSATransportadora'">
	   	  INNER JOIN
		    logbook06_cnpjs_transportadoras
		  ON
		    logbook06_cnpjs_transportadoras.flogbook06_cnpj = logbook07_logbook.flogbook07_cnpj_transportadora
		  INNER JOIN
		    logbook05_transportadoras
		  ON
		    logbook05_transportadoras.flogbook05_id = logbook06_cnpjs_transportadoras.flogbook05_id
		  INNER JOIN
		    logbook16_transportadoras_usuarios
		  ON
		    logbook16_transportadoras_usuarios.flogbook05_id = logbook05_transportadoras.flogbook05_id
		  INNER JOIN
		    tscy02h_usuario
	      ON
		    logbook16_transportadoras_usuarios.fscy02_id = tscy02h_usuario.ascy02_id
   		</if>
   		WHERE
			flogbook07_week in (
				SELECT DISTINCT 
					flogbook07_week 
				FROM 
					logbook07_logbook 
				WHERE 
					date_part('year', flogbook07_data_emissao_cte) = date_part('year', now()) 
				ORDER BY 
					flogbook07_week 
				DESC LIMIT 12
			)
         AND
			date_part('year', flogbook07_data_emissao_cte) = date_part('year', now())
		<if test="user.group.group == 'WSATransportadora'">
		  AND
            tscy02h_usuario.ascy02_id = #{user.id}
   		</if>
		GROUP BY 
			flogbook07_week
		ORDER BY 
			flogbook07_week
		LIMIT 12
    </select>
    
    <select id="selectStatus" resultMap="result" parameterType="GraficoVO" >
        SELECT DISTINCT ON (flogbook07_status) 
        	COUNT(flogbook07_status) as count, 
        	SUM(flogbook07_valor_emissao_cte) as valor,
        	flogbook07_status as status, 
        	flogbook07_week as week,
			date_part('year', flogbook07_data_emissao_cte),
			date_part('year', now())
        FROM
        	logbook07_logbook
        <if test="user.group.group == 'WSATransportadora'">
	   	  INNER JOIN
		    logbook06_cnpjs_transportadoras
		  ON
		    logbook06_cnpjs_transportadoras.flogbook06_cnpj = logbook07_logbook.flogbook07_cnpj_transportadora
		  INNER JOIN
		    logbook05_transportadoras
		  ON
		    logbook05_transportadoras.flogbook05_id = logbook06_cnpjs_transportadoras.flogbook05_id
		  INNER JOIN
		    logbook16_transportadoras_usuarios
		  ON
		    logbook16_transportadoras_usuarios.flogbook05_id = logbook05_transportadoras.flogbook05_id
		  INNER JOIN
		    tscy02h_usuario
	      ON
		    logbook16_transportadoras_usuarios.fscy02_id = tscy02h_usuario.ascy02_id
   		</if>
		WHERE
			flogbook07_week = (
				SELECT DISTINCT 
					flogbook07_week 
				FROM 
					logbook07_logbook 
				WHERE 
					date_part('year', flogbook07_data_emissao_cte) = date_part('year', now()) 
				ORDER BY 
					flogbook07_week 
				DESC LIMIT 1
			)
         AND
			date_part('year', flogbook07_data_emissao_cte) = date_part('year', now())
		<if test="user.group.group == 'WSATransportadora'">
		  AND
            tscy02h_usuario.ascy02_id = #{user.id}
   		</if>
		GROUP BY
			flogbook07_week,
			flogbook07_status,
			flogbook07_data_emissao_cte
    </select>
    
    <select id="selectLastWeek" resultMap="result" parameterType="GraficoVO" >
        SELECT
			COUNT(*) as count, 
			SUM(flogbook07_valor_emissao_cte) as valor 
		FROM
			logbook07_logbook
		<if test="user.group.group == 'WSATransportadora'">
		  INNER JOIN
		    logbook06_cnpjs_transportadoras
		  ON
		    logbook06_cnpjs_transportadoras.flogbook06_cnpj = logbook07_logbook.flogbook07_cnpj_transportadora
		  INNER JOIN
		    logbook05_transportadoras
		  ON
		    logbook05_transportadoras.flogbook05_id = logbook06_cnpjs_transportadoras.flogbook05_id
		  INNER JOIN
		    logbook16_transportadoras_usuarios
		  ON
		    logbook16_transportadoras_usuarios.flogbook05_id = logbook05_transportadoras.flogbook05_id
		  INNER JOIN
		    tscy02h_usuario
		  ON
		    logbook16_transportadoras_usuarios.fscy02_id = tscy02h_usuario.ascy02_id
		</if>
		WHERE
			flogbook07_week = (
				SELECT DISTINCT 
					flogbook07_week 
				FROM 
					logbook07_logbook 
				WHERE 
					date_part('year', flogbook07_data_emissao_cte) = date_part('year', now()) 
				ORDER BY 
					flogbook07_week 
				DESC LIMIT 1
			)
		AND
			date_part('year', flogbook07_data_emissao_cte) = date_part('year', now())
		<if test="user.group.group == 'WSATransportadora'">
		  AND
		    tscy02h_usuario.ascy02_id = #{user.id}
		</if>
    </select>

    <resultMap id="result" type="GraficoVO">
        <result property="week" column="week" />
		<result property="count" column="count" />
		<result property="valor" column="valor" />
		<result property="status" column="status" />
    </resultMap>

</mapper>